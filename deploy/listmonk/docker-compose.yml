# Listmonk on EC2 for https://listmonk.studiokiln.io
# Run on the EC2 host; Nginx on host proxies to 127.0.0.1:9000.
# Usage: docker compose up -d
# Optional first run: LISTMONK_ADMIN_USER=admin LISTMONK_ADMIN_PASSWORD=changeme docker compose up -d

x-db-credentials: &db-credentials
  POSTGRES_USER: listmonk
  POSTGRES_PASSWORD: listmonk
  POSTGRES_DB: listmonk

services:
  app:
    image: listmonk/listmonk:latest
    container_name: listmonk_app
    restart: unless-stopped
    ports:
      - "127.0.0.1:9000:9000"
    networks:
      - listmonk
    hostname: listmonk.studiokiln.io
    depends_on:
      db:
        condition: service_healthy
    command: [sh, -c, "./listmonk --install --idempotent --yes --config '' && ./listmonk --upgrade --yes --config '' && ./listmonk --config ''"]
    environment:
      LISTMONK_app__address: "0.0.0.0:9000"
      LISTMONK_db__user: listmonk
      LISTMONK_db__password: listmonk
      LISTMONK_db__database: listmonk
      LISTMONK_db__host: db
      LISTMONK_db__port: "5432"
      LISTMONK_db__ssl_mode: disable
      LISTMONK_db__max_open: "25"
      LISTMONK_db__max_idle: "25"
      LISTMONK_db__max_lifetime: 300s
      TZ: Etc/UTC
      # Set on first run to auto-create admin: LISTMONK_ADMIN_USER, LISTMONK_ADMIN_PASSWORD
      LISTMONK_ADMIN_USER: ${LISTMONK_ADMIN_USER:-}
      LISTMONK_ADMIN_PASSWORD: ${LISTMONK_ADMIN_PASSWORD:-}
      # SMTP: set in .env or here for sending (e.g. LISTMONK_smtp__host, LISTMONK_smtp__port, LISTMONK_smtp__username, LISTMONK_smtp__password, LISTMONK_smtp__from_address)
    volumes:
      - listmonk-uploads:/listmonk/uploads

  db:
    image: postgres:17-alpine
    container_name: listmonk_db
    restart: unless-stopped
    ports:
      - "127.0.0.1:5432:5432"
    networks:
      - listmonk
    environment:
      <<: *db-credentials
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U listmonk"]
      interval: 10s
      timeout: 5s
      retries: 6
    volumes:
      - listmonk-data:/var/lib/postgresql/data

networks:
  listmonk:

volumes:
  listmonk-data:
  listmonk-uploads:
